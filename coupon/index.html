<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025 æ—¥æœ¬å„ªæƒ åˆ¸æ•´ç† è³¼ç‰©æ—…éŠå¿…å‚™! - Junlando</title>
  <meta
    name="description"
    content="è—¥å¦, å®¶é›», é›œè²¨,ç™¾è²¨å…¨æ”¶éŒ„,çœéŒ¢å¿…çœ‹ã€‚æ—¥æœ¬è³¼ç‰©å¿…å‚™å„ªæƒ åˆ¸ï¼Bic Cameraã€æ¾æœ¬æ¸…ã€å¤§åœ‹è—¥å¦ã€å”å‰è¨¶å¾·ã€å¤šæ…¶å±‹ç­‰é›»å™¨ã€è—¥å¦ã€é›œè²¨åº—å®¶å„ªæƒ åˆ¸å…¨æ”¶éŒ„ï¼Œé…åˆå…ç¨…çœè¶…å¤šã€‚"
  />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --primary-color: #e53935;
      --accent-color: #ff9800;
      --background-color: #f5f5f5;
      --coupon-color: #f44336;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fff;
    }

    /* æ¨™é¡Œå€å¡Š */
    .header-section {
      background: linear-gradient(to right, #ffebee, #ffffff);
      padding: 20px 50px;
      border-bottom: 2px solid #eee;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
    }

    .header-top-row {
      display: none;
    }

    .mobile-download-buttons {
      display: none;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .mobile-download-label {
      display: none;
      font-size: 13px;
      color: #666;
      font-weight: 500;
      margin-bottom: 4px;
      text-align: center;
    }

    /* åº•éƒ¨æ°”æ³¡æç¤ºæ¡† */
    .mobile-download-banner {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #0080FF 0%, #0066CC 100%);
      color: white;
      padding: 16px 20px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
    }

    .mobile-download-banner.show {
      display: block;
      transform: translateY(0);
    }

    .mobile-download-banner.hide {
      transform: translateY(100%);
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    @keyframes slideDown {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(100%);
      }
    }

    .banner-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .banner-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
    }

    .banner-button {
      background: white;
      color: #0080FF;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      text-decoration: none;
      font-size: 14px;
      white-space: nowrap;
      transition: transform 0.2s;
    }

    .banner-button:hover {
      transform: scale(1.05);
    }

    .mobile-download-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #ddd;
      text-decoration: none;
      transition: all 0.2s;
    }

    .mobile-download-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .mobile-download-btn img {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }

    .logo-box {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      overflow: hidden;
    }

    .logo-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
    }

    .main-title {
      flex: 1;
    }

    .mobile-title {
      display: none;
    }

    .main-title h1 {
      font-size: 2.5em;
      color: #333;
      margin: 0 0 5px 0;
    }

    .main-title h2 {
      font-size: 1.2em;
      color: #777;
      margin: 0;
      font-weight: normal;
    }

    .brand-name {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
      flex-shrink: 0;
    }

    /* ä¸»å°èˆª */
    .main-nav {
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .main-nav ul {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0;
      list-style: none;
      display: flex;
    }

    .main-nav li {
      padding: 15px 30px;
      cursor: pointer;
      font-weight: bold;
      color: #555;
      transition: all 0.3s;
    }

    .main-nav li.active {
      border-bottom: 3px solid var(--primary-color);
      color: var(--primary-color);
    }

    .main-nav li:not(.active) {
      border-bottom: none;
    }

    .main-nav li:hover {
      color: var(--primary-color);
    }

    /* ä¸»å…§å®¹å€å¡Š (Flex) */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      display: flex;
      gap: 20px;
      padding: 0 20px;
    }

    .main-content {
      flex-grow: 1;
      width: 70%;
    }

    .sidebar {
      width: 300px;
      flex-shrink: 0;
    }

    /* ç¯©é¸å™¨ */
    .filter-bar {
      background-color: #fff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .category-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .category-tab {
      padding: 8px 15px;
      background-color: var(--background-color);
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .category-tab:hover {
      background-color: #e0e0e0;
    }

    .category-tab.active {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .search-container {
      display: flex;
    }

    .search-container input {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px 0 0 5px;
      font-size: 14px;
    }

    .search-container button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      font-weight: bold;
    }

    /* å„ªæƒ åˆ¸å¡ç‰‡ */
    .coupon-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .coupon-card {
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      background-image: url('drawables/coupon_frame.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .coupon-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .coupon-card-inner {
      background: rgba(255, 255, 255, 0.95);
    }

    .coupon-header {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px dashed #eee;
      background: #ffe5e5;
    }

    .coupon-logo {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      margin-right: 10px;
      object-fit: contain;
      background: white;
      padding: 4px;
    }

    .coupon-title {
      font-weight: bold;
      font-size: 1.1em;
      flex: 1;
    }

    .coupon-status {
      margin-left: auto;
      background-color: #0080FF;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 0.8em;
      color: white;
      font-weight: bold;
    }

    .coupon-details {
      padding: 15px;
      display: flex;
      align-items: center;
    }

    .discount-badge {
      background-color: var(--coupon-color);
      color: white;
      font-size: 2em;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      margin-right: 15px;
      min-width: 80px;
      text-align: center;
    }

    .coupon-info {
      font-size: 0.9em;
      color: #555;
      flex: 1;
    }

    .coupon-info strong {
      color: var(--coupon-color);
    }

    .coupon-info small {
      display: block;
      color: #999;
      margin-top: 3px;
    }

    /* å´é‚Šä¸‹è¼‰æ¬„ */
    .download-box {
      background-color: var(--primary-color);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .download-box h3 {
      margin-top: 0;
      font-size: 1.2em;
    }

    .download-box p {
      font-size: 0.9em;
      margin-bottom: 20px;
    }

    .app-store-button, .google-play-button {
      display: block;
      background-color: white;
      color: var(--primary-color);
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .app-store-button:hover, .google-play-button:hover {
      transform: scale(1.05);
    }

    .qr-code-section {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      gap: 10px;
    }

    .qr-code-item {
      text-align: center;
    }

    .qr-code-section img {
      width: 100px;
      height: 100px;
      background-color: white;
      border: 1px solid #fff;
      border-radius: 5px;
      padding: 8px;
    }

    .qr-label {
      display: block;
      font-size: 0.8em;
      margin-top: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 16px;
    }

    /* åœ°åœ–ç›¸é—œæ¨£å¼ */
    .map-container {
      display: none;
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 20px;
      position: relative;
    }

    .map-container.active {
      display: block;
    }

    #store-map {
      width: 100%;
      height: 100%;
      border-radius: 5px;
    }

    .refresh-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .refresh-button:hover {
      background-color: #c62828;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .refresh-button:active {
      transform: scale(0.95);
    }

    .map-status {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background: rgba(245, 245, 245, 0.95);
      border-top: 1px solid #ddd;
      font-size: 14px;
      color: #666;
    }

    .coupon-content {
      display: block;
    }

    .coupon-content.hidden {
      display: none;
    }

    @media (max-width: 900px) {
      .header-section {
        padding: 15px 20px;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      /* éšè—æ¡Œé¢ç«¯çš„ logo å’Œæ ‡é¢˜ */
      .header-content > .logo-box,
      .header-content > .main-title:not(.mobile-title) {
        display: none;
      }

      /* æ˜¾ç¤ºç§»åŠ¨ç«¯çš„å¸ƒå±€ */
      .header-top-row {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .mobile-download-buttons {
        display: flex;
      }

      .mobile-download-label {
        display: block;
      }

      .mobile-title {
        display: block;
        width: 100%;
      }

      .main-title h1 {
        font-size: 1.8em;
      }

      .main-title h2 {
        font-size: 1em;
      }

      .container {
        flex-direction: column;
      }

      .main-content {
        width: 100%;
      }

      .sidebar {
        width: 100%;
      }

      .download-box {
        position: static;
      }

      .coupon-card {
        width: 100%;
      }

      .coupon-details {
        flex-direction: column;
        align-items: flex-start;
      }

      .discount-badge {
        margin-bottom: 10px;
      }
    }
  </style>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDOc1-a54mn3BCZzAhol5o7tJ-TH72uA1A",
      authDomain: "couponweb-fc6f9.firebaseapp.com",
      projectId: "couponweb-fc6f9",
      storageBucket: "couponweb-fc6f9.firebasestorage.app",
      messagingSenderId: "833095007382",
      appId: "1:833095007382:web:10aca346a680ce9947d6b7",
      measurementId: "G-VGPEQDL1RH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
  </script>
</head>
<body>
  <header class="header-section">
    <div class="header-content">
      <!-- æ¡Œé¢ç«¯å¸ƒå±€ï¼šlogo å’Œæ ‡é¢˜åœ¨åŒä¸€è¡Œ -->
      <div class="logo-box">
        <img src="drawables/net_icon.png" alt="COUPON" />
      </div>
      <div class="main-title">
        <h1>2025 æ—¥æœ¬å„ªæƒ åˆ¸æ•´ç† è³¼ç‰©æ—…éŠå¿…å‚™!</h1>
        <h2>è—¥å¦ã€å®¶é›»ã€é›œè²¨ã€ç™¾è²¨å…¨æ”¶éŒ„ï¼ŒçœéŒ¢å¿…çœ‹</h2>
      </div>
      <!-- ç§»åŠ¨ç«¯å¸ƒå±€ï¼šlogo å’Œä¸‹è½½æŒ‰é’®åœ¨ç¬¬ä¸€è¡Œï¼Œæ ‡é¢˜åœ¨ç¬¬äºŒè¡Œ -->
      <div class="header-top-row">
        <div class="logo-box">
          <img src="drawables/net_icon.png" alt="COUPON" />
        </div>
        <div class="mobile-download-buttons">
          <span class="mobile-download-label">æ‰‹æ©Ÿç‰ˆä¸‹è¼‰</span>
          <div style="display: flex; gap: 8px; align-items: center;">
            <a href="https://apps.apple.com/tw/app/%E6%97%A5%E6%9C%AC%E5%84%AA%E6%83%A0%E5%88%B8-2025-%E6%97%A5%E6%9C%AC%E8%B3%BC%E7%89%A9-%E6%97%85%E9%81%8A%E5%BF%85%E5%82%99-%E6%97%A5%E5%B9%A3%E6%8F%9B%E7%AE%97/id6449156306" 
               target="_blank" 
               rel="noopener noreferrer"
               class="mobile-download-btn">
              <img src="drawables/app_store_icon.png" alt="App Store" />
            </a>
            <a href="https://play.google.com/store/apps/details?id=com.junlando.japancoupon" 
               target="_blank" 
               rel="noopener noreferrer"
               class="mobile-download-btn">
              <img src="drawables/google_play_icon.png" alt="Google Play" />
            </a>
          </div>
        </div>
      </div>
      <div class="main-title mobile-title">
        <h1>2025 æ—¥æœ¬å„ªæƒ åˆ¸æ•´ç† è³¼ç‰©æ—…éŠå¿…å‚™!</h1>
        <h2>è—¥å¦ã€å®¶é›»ã€é›œè²¨ã€ç™¾è²¨å…¨æ”¶éŒ„ï¼ŒçœéŒ¢å¿…çœ‹</h2>
      </div>
    </div>
  </header>

  <nav class="main-nav">
    <ul>
      <li class="nav-tab active" data-tab="coupons">å„ªæƒ åˆ¸</li>
      <li class="nav-tab" data-tab="map">é™„è¿‘å•†å®¶åœ°åœ–</li>
    </ul>
  </nav>

  <div class="container">
    <main class="main-content">
      <!-- å„ªæƒ åˆ¸å…§å®¹ -->
      <div class="coupon-content" id="coupon-content">
      <section class="filter-bar">
        <div class="category-tabs" id="category-filters">
          <button class="category-tab active" data-category="all">å…¨éƒ¨</button>
          <button class="category-tab" data-category="drugstoreAndDaily">è—¥å¦</button>
          <button class="category-tab" data-category="electronics">é›»å™¨</button>
          <button class="category-tab" data-category="departmentStore">ç™¾è²¨</button>
          <button class="category-tab" data-category="airportDutyFree">æ©Ÿå ´</button>
          <button class="category-tab" data-category="fashion">æœé£¾é…</button>
          <button class="category-tab" data-category="sports">é‹å‹•</button>
          <button class="category-tab" data-category="animeAndGoods">å‹•æ¼«</button>
          <button class="category-tab" data-category="online">ç·šä¸Š</button>
        </div>
        <div class="search-container">
          <input type="text" id="search-input" placeholder="æœå°‹å„ªæƒ åˆ¸" />
          <button onclick="filterCoupons()">æœå°‹</button>
        </div>
      </section>

      <section class="coupon-list" id="coupon-list">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“‹</div>
          <div class="empty-state-text">è¼‰å…¥ä¸­...</div>
        </div>
      </section>
      </div>

      <!-- åœ°åœ–å…§å®¹ -->
      <div class="coupon-content hidden" id="map-content">
        <div class="map-container active" id="map-container">
          <div id="store-map"></div>
            <button class="refresh-button" id="refresh-map-btn" onclick="refreshMapMarkers()">æœç´¢é™„è¿‘å€åŸŸ</button>
          <div class="map-status">
            <span id="map-status-text">åœ°åœ–è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
    </main>

    <aside class="sidebar">
      <div class="download-box">
        <h3>ä¸‹è¼‰ App</h3>
        <p>éš¨æ™‚éš¨åœ°ç²å–æŠ˜æ‰£ï¼Œå†ä¹Ÿä¸ç”¨æ“”å¿ƒéŒ¯éä¸‹è¼‰é€£çµï¼</p>
        <a href="#" class="app-store-button" id="sidebar-app-store-link" target="_blank">App Store</a>
        <a href="https://play.google.com/store/apps/details?id=com.junlando.japancoupon" class="google-play-button" id="sidebar-google-play-link" target="_blank">Google Play</a>
        
        <div class="qr-code-section">
          <div class="qr-code-item">
            <img src="drawables/ios_qrcode.png" alt="iOS ä¸‹è¼‰ QR Code" />
            <span class="qr-label">iOS ä¸‹è¼‰</span>
          </div>
          <div class="qr-code-item">
            <img src="drawables/android_qrcode.png" alt="Android ä¸‹è¼‰ QR Code" />
            <span class="qr-label">Android ä¸‹è¼‰</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // App Store é€£çµ
    const APP_STORE_URL = 'https://apps.apple.com/tw/app/%E6%97%A5%E6%9C%AC%E5%84%AA%E6%83%A0%E5%88%B8-2025-%E6%97%A5%E6%9C%AC%E8%B3%BC%E7%89%A9-%E6%97%85%E9%81%8A%E5%BF%85%E5%82%99-%E6%97%A5%E5%B9%A3%E6%8F%9B%E7%AE%97/id6449156306';
    const GOOGLE_PLAY_URL = 'https://play.google.com/store/apps/details?id=com.junlando.japancoupon';

    let coupons = [];
    let filteredCoupons = [];
    let currentCategory = 'all';
    let searchQuery = '';

    // åˆ†é¡åç¨±å°æ‡‰
    const categoryNames = {
      all: 'å…¨éƒ¨',
      drugstoreAndDaily: 'è—¥å¦',
      electronics: 'é›»å™¨',
      departmentStore: 'ç™¾è²¨',
      airportDutyFree: 'æ©Ÿå ´',
      fashion: 'æœé£¾é…',
      sports: 'é‹å‹•',
      animeAndGoods: 'å‹•æ¼«',
      online: 'ç·šä¸Š'
    };

    // è¼‰å…¥å„ªæƒ åˆ¸è³‡æ–™
    async function loadCoupons() {
      try {
        const response = await fetch('coupons.json');
        coupons = await response.json();
        filteredCoupons = [...coupons];
        renderCoupons();
      } catch (error) {
        console.error('è¼‰å…¥å„ªæƒ åˆ¸å¤±æ•—:', error);
        document.getElementById('coupon-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âŒ</div>
            <div class="empty-state-text">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          </div>
        `;
      }
    }

    // æ ¼å¼åŒ–æˆªæ­¢æ—¥æœŸ
    function formatDeadline(timestamp) {
      if (!timestamp) return 'ç„¡é™æœŸ';
      const date = new Date(timestamp * 1000);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `æˆªæ­¢æ—¥æœŸ: ${year}/${month}/${day}`;
    }

    // ç²å–åœ–æ¨™è·¯å¾‘
    function getIconPath(imageName) {
      const iconMap = {
        'donki': 'donki.jpeg',
        'matsu': 'matsu.png',
        'big_camera': 'big_camera.png',
        'daikoku': 'daikoku.jpg',
        'sapporo': 'sapporo.jpeg',
        'daimaru': 'daimaru.png',
        'victoria': 'victoria.png',
        'mitsui': 'mitsui.png',
        'edion': 'edion.png',
        'duty_free': 'duty_free.png',
        'aeon': 'aeon.png',
        'aeon_mall': 'aeon_mall.png',
        'tsuruha': 'tsuruha.png',
        'keio': 'keio.png',
        'sundrug': 'sundrug.jpeg',
        'tobu': 'tobu.png',
        'cosmos': 'cosmos.png',
        'cosmetics': 'cosmetics.png',
        'takeya': 'takeya.png',
        'yamada': 'yamada.png',
        'alphen_tokyo': 'alphen_tokyo.png',
        'laox': 'laox.png',
        'gu': 'gu.png',
        'sugi': 'sugi.png',
        'ana': 'ana.png',
        'new1': 'new1.jpg',
        'west': 'west.png',
        'kokumin': 'kokumin.jpg',
        'cocokarafine': 'cocokarafine.png',
        'odakyu': 'odakyu.jpg',
        'aoki': 'aoki.png',
        'orihica': 'orihica.png',
        'wamazing': 'wamazing.png',
        'fasola': 'fasola.png',
        'snowpeak': 'snowpeak.png',
        'jungle': 'jungle.png',
        'briefing': 'briefing.png',
        'aoyama': 'aoyama.png',
        'paris': 'paris.jpeg',
        'ohga': 'ohga.png',
        'meitetsu': 'meitetsu.png',
        'lotte': 'lotte.jpeg'
      };
      
      const fileName = iconMap[imageName] || `${imageName}.png`;
      return `store_icons/${fileName}`;
    }

    // ç²å–å„ªæƒ åˆ¸åœ–ç‰‡è·¯å¾‘
    function getCouponImagePath(imageURL) {
      if (!imageURL) return null;
      if (imageURL.endsWith('.pdf')) {
        return `coupon_images/${imageURL.replace('.pdf', '.jpg')}`;
      }
      return `coupon_images/${imageURL}`;
    }

    // è™•ç†å„ªæƒ åˆ¸é»æ“Š
    function handleCouponClick(coupon) {
      if (coupon.link) {
        window.open(coupon.link, '_blank');
      } else if (coupon.imageURL) {
        const imagePath = getCouponImagePath(coupon.imageURL);
        if (imagePath) {
          const newWindow = window.open('', '_blank');
          newWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>${coupon.title} - å„ªæƒ åˆ¸</title>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                body {
                  margin: 0;
                  padding: 20px;
                  background: #f5f5f5;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  min-height: 100vh;
                }
                img {
                  max-width: 100%;
                  height: auto;
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
              </style>
            </head>
            <body>
              <img src="${imagePath}" alt="${coupon.title}" onerror="this.parentElement.innerHTML='<p>åœ–ç‰‡è¼‰å…¥å¤±æ•—</p>'" />
            </body>
            </html>
          `);
        }
      }
    }

    // æ¸²æŸ“å„ªæƒ åˆ¸åˆ—è¡¨
    function renderCoupons() {
      const listEl = document.getElementById('coupon-list');
      
      if (filteredCoupons.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ”</div>
            <div class="empty-state-text">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å„ªæƒ åˆ¸</div>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filteredCoupons.map(coupon => {
        const iconPath = getIconPath(coupon.imageName);
        const deadlineText = formatDeadline(coupon.deadline);
        const discountText = coupon.discountUnit === 'æŠ˜' 
          ? `${coupon.discountNumber}æŠ˜`
          : `${coupon.discountNumber}${coupon.discountUnit}`;
        
        return `
          <div class="coupon-card" onclick="handleCouponClick(${JSON.stringify(coupon).replace(/"/g, '&quot;')})">
            <div class="coupon-card-inner">
              <div class="coupon-header">
                <img src="${iconPath}" alt="${coupon.title}" class="coupon-logo" onerror="this.src='store_icons/icon.png'" />
                <div class="coupon-title">${coupon.title}</div>
                <div class="coupon-status">é»æ“Šä½¿ç”¨</div>
              </div>
              <div class="coupon-details">
                <div class="discount-badge">${discountText}</div>
                <div class="coupon-info">
                  <strong>${coupon.description}</strong>
                  <small>${deadlineText}</small>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // æ·»åŠ é»æ“Šäº‹ä»¶
      listEl.querySelectorAll('.coupon-card').forEach((card, index) => {
        card.addEventListener('click', () => {
          handleCouponClick(filteredCoupons[index]);
        });
      });
    }

    // ç¯©é¸å„ªæƒ åˆ¸
    function filterCoupons() {
      filteredCoupons = coupons.filter(coupon => {
        if (currentCategory !== 'all' && coupon.type !== currentCategory) {
          return false;
        }
        
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          return coupon.title.toLowerCase().includes(query) ||
                 coupon.description.toLowerCase().includes(query);
        }
        
        return true;
      });
      
      renderCoupons();
    }

    // åˆ†é¡æŒ‰éˆ•é»æ“Š
    document.getElementById('category-filters').addEventListener('click', (e) => {
      if (e.target.classList.contains('category-tab')) {
        document.querySelectorAll('.category-tab').forEach(btn => {
          btn.classList.remove('active');
        });
        e.target.classList.add('active');
        
        currentCategory = e.target.dataset.category;
        filterCoupons();
      }
    });

    // æœå°‹è¼¸å…¥
    document.getElementById('search-input').addEventListener('input', (e) => {
      searchQuery = e.target.value;
      filterCoupons();
    });

    // è™•ç†å„ªæƒ åˆ¸é»æ“Šï¼ˆå…¨åŸŸå‡½æ•¸ï¼‰
    window.handleCouponClick = function(coupon) {
      if (coupon.link) {
        window.open(coupon.link, '_blank');
      } else if (coupon.imageURL) {
        const imagePath = getCouponImagePath(coupon.imageURL);
        if (imagePath) {
          const newWindow = window.open('', '_blank');
          newWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>${coupon.title} - å„ªæƒ åˆ¸</title>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                body {
                  margin: 0;
                  padding: 20px;
                  background: #f5f5f5;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  min-height: 100vh;
                }
                img {
                  max-width: 100%;
                  height: auto;
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
              </style>
            </head>
            <body>
              <img src="${imagePath}" alt="${coupon.title}" onerror="this.parentElement.innerHTML='<p>åœ–ç‰‡è¼‰å…¥å¤±æ•—</p>'" />
            </body>
            </html>
          `);
        }
      }
    };

    // ================================
    // åœ°åœ–ç›¸é—œåŠŸèƒ½
    // ================================
    let storeMap = null;
    let storeMarkers = [];
    let userMarker = null;
    let allMarkersData = []; // æ‰€æœ‰å•†å®¶æ¨™è¨˜æ•¸æ“š
    const TOKYO_CENTER = [35.6762, 139.6503]; // æ±äº¬é»˜èªä½ç½®

    // Tab åˆ‡æ›
    function initTabs() {
      const tabs = document.querySelectorAll('.nav-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // æ›´æ–° tab æ¨£å¼
          tabs.forEach(t => {
            t.classList.remove('active');
          });
          tab.classList.add('active');

          // åˆ‡æ›å…§å®¹
          const tabName = tab.dataset.tab;
          const couponContent = document.getElementById('coupon-content');
          const mapContent = document.getElementById('map-content');

          if (tabName === 'coupons') {
            couponContent.classList.remove('hidden');
            mapContent.classList.add('hidden');
          } else if (tabName === 'map') {
            couponContent.classList.add('hidden');
            mapContent.classList.remove('hidden');
            // ç¢ºä¿å…ƒç´ å¯è¦‹å¾Œå†åˆå§‹åŒ–åœ°åœ–
            setTimeout(() => {
              initMap();
            }, 100);
          }
        });
      });
    }

    // ç²å–ç”¨æˆ¶ä½ç½®
    function getUserLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve(TOKYO_CENTER);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve([position.coords.latitude, position.coords.longitude]);
          },
          (error) => {
            console.log('ç„¡æ³•ç²å–ä½ç½®:', error);
            resolve(TOKYO_CENTER);
          },
          { timeout: 5000 }
        );
      });
    }

    // ç²å–å“ç‰Œåœ–æ¨™è·¯å¾‘
    function getBrandIconPath(brand) {
      const iconMap = {
        'donki': 'donki.jpeg',
        'matsu': 'matsu.png',
        'big_camera': 'big_camera.png',
        'daikoku': 'daikoku.jpg',
        'sapporo': 'sapporo.jpeg',
        'daimaru': 'daimaru.png',
        'victoria': 'victoria.png',
        'mitsui': 'mitsui.png',
        'edion': 'edion.png',
        'duty_free': 'duty_free.png',
        'aeon': 'aeon.png',
        'aeon_mall': 'aeon_mall.png',
        'tsuruha': 'tsuruha.png',
        'keio': 'keio.png',
        'sundrug': 'sundrug.jpeg',
        'tobu': 'tobu.png',
        'cosmos': 'cosmos.png',
        'cosmetics': 'cosmetics.png',
        'takeya': 'takeya.png',
        'yamada': 'yamada.png',
        'alphen_tokyo': 'alphen_tokyo.png',
        'laox': 'laox.png',
        'gu': 'gu.png',
        'sugi': 'sugi.png',
        'ana': 'ana.png',
        'new1': 'new1.jpg',
        'west': 'west.png',
        'kokumin': 'kokumin.jpg',
        'cocokarafine': 'cocokarafine.png',
        'odakyu': 'odakyu.jpg',
        'aoki': 'aoki.png',
        'orihica': 'orihica.png',
        'wamazing': 'wamazing.png',
        'fasola': 'fasola.png',
        'snowpeak': 'snowpeak.png',
        'jungle': 'jungle.png',
        'briefing': 'briefing.png',
        'aoyama': 'aoyama.png',
        'paris': 'paris.jpeg',
        'ohga': 'ohga.png',
        'meitetsu': 'meitetsu.png',
        'lotte': 'lotte.jpeg'
      };

      const fileName = iconMap[brand] || 'icon.png';
      return `store_icons/${fileName}`;
    }

    // åˆå§‹åŒ–åœ°åœ–
    async function initMap() {
      if (storeMap) {
        return; // åœ°åœ–å·²åˆå§‹åŒ–
      }

      const mapEl = document.getElementById('store-map');
      const statusEl = document.getElementById('map-status-text');

      if (!mapEl || !statusEl) {
        console.warn('åœ°åœ–å…ƒç´ æˆ–ç‹€æ…‹å…ƒç´ ä¸å­˜åœ¨');
        return;
      }

      statusEl.textContent = 'æ­£åœ¨è¼‰å…¥åœ°åœ–...';

      // ç²å–ç”¨æˆ¶ä½ç½®
      const userLocation = await getUserLocation();

      // åˆå§‹åŒ–åœ°åœ–
      storeMap = L.map('store-map').setView(userLocation, 15);

      // æ·»åŠ åœ°åœ–åœ–å±¤
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18,
      }).addTo(storeMap);

      // æ·»åŠ ç”¨æˆ¶ä½ç½®æ¨™è¨˜
      const userIcon = L.divIcon({
        className: 'user-location-marker',
        html: '<div style="width: 20px; height: 20px; background: #4285f4; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      userMarker = L.marker(userLocation, { icon: userIcon })
        .addTo(storeMap)
        .bindPopup('æ‚¨çš„ä½ç½®');

      // è¼‰å…¥æ‰€æœ‰å•†å®¶æ•¸æ“š
      await loadAllMarkersData();

      // è¼‰å…¥ç•¶å‰è¦–é‡ç¯„åœå…§çš„å•†å®¶æ¨™è¨˜
      await refreshMapMarkers();

      // ç›£è½åœ°åœ–ç§»å‹•å’Œç¸®æ”¾äº‹ä»¶ï¼ˆä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é »ç¹åˆ·æ–°ï¼‰
      // æ³¨æ„ï¼šæš«æ™‚ä¸è‡ªå‹•åˆ·æ–°ï¼Œåªæä¾›æ‰‹å‹•åˆ·æ–°æŒ‰éˆ•ï¼Œé¿å…å¡é “
      // å¦‚æœéœ€è¦è‡ªå‹•åˆ·æ–°ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„è¨»é‡‹
      /*
      storeMap.on('moveend', () => {
        if (window.isRefreshingMarkers) return;
        if (mapMoveTimeout) {
          clearTimeout(mapMoveTimeout);
        }
        mapMoveTimeout = setTimeout(() => {
          if (!window.isRefreshingMarkers) {
            refreshMapMarkers();
          }
        }, 1000); // é˜²æŠ–ï¼Œ1ç§’å¾Œæ‰åˆ·æ–°
      });

      storeMap.on('zoomend', () => {
        if (window.isRefreshingMarkers) return;
        if (mapMoveTimeout) {
          clearTimeout(mapMoveTimeout);
        }
        mapMoveTimeout = setTimeout(() => {
          if (!window.isRefreshingMarkers) {
            refreshMapMarkers();
          }
        }, 1000);
      });
      */
    }

    // è¼‰å…¥æ‰€æœ‰å•†å®¶æ•¸æ“šï¼ˆåªè¼‰å…¥ä¸€æ¬¡ï¼‰
    async function loadAllMarkersData() {
      if (allMarkersData && allMarkersData.length > 0) {
        return; // å·²ç¶“è¼‰å…¥é
      }

      try {
        const response = await fetch('markers.json');
        allMarkersData = await response.json();
      } catch (error) {
        console.error('è¼‰å…¥å•†å®¶æ•¸æ“šå¤±æ•—:', error);
        const statusEl = document.getElementById('map-status-text');
        if (statusEl) {
          statusEl.textContent = 'è¼‰å…¥å•†å®¶æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        }
      }
    }

    // åˆ·æ–°åœ°åœ–æ¨™è¨˜ï¼ˆåªé¡¯ç¤ºç•¶å‰è¦–é‡ç¯„åœå…§çš„ï¼‰
    async function refreshMapMarkers() {
      if (!storeMap || allMarkersData.length === 0) {
        return;
      }

      // é˜²æ­¢é‡è¤‡åˆ·æ–°
      if (window.isRefreshingMarkers) {
        return;
      }
      window.isRefreshingMarkers = true;

      const statusEl = document.getElementById('map-status-text');
      if (statusEl) {
        statusEl.textContent = 'æ­£åœ¨è¼‰å…¥å•†å®¶ä½ç½®...';
      }

      // æ¸…é™¤ç¾æœ‰æ¨™è¨˜ï¼ˆæ‰¹é‡ç§»é™¤ï¼Œæé«˜æ€§èƒ½ï¼‰
      if (storeMarkers.length > 0) {
        // åˆ†æ‰¹ç§»é™¤ï¼Œé¿å…ä¸€æ¬¡æ€§ç§»é™¤å¤ªå¤šå°è‡´å¡é “
        const removeBatchSize = 100;
        for (let i = 0; i < storeMarkers.length; i += removeBatchSize) {
          const batch = storeMarkers.slice(i, i + removeBatchSize);
          batch.forEach(marker => {
            storeMap.removeLayer(marker);
          });
          // è®“ç€è¦½å™¨æœ‰æ™‚é–“è™•ç†
          if (i + removeBatchSize < storeMarkers.length) {
            await new Promise(resolve => setTimeout(resolve, 0));
          }
        }
        storeMarkers = [];
      }

      // ç²å–ç•¶å‰åœ°åœ–è¦–é‡ç¯„åœ
      const bounds = storeMap.getBounds();
      const north = bounds.getNorth();
      const south = bounds.getSouth();
      const east = bounds.getEast();
      const west = bounds.getWest();

      // éæ¿¾å‡ºè¦–é‡ç¯„åœå…§çš„markersï¼ˆä½¿ç”¨æ›´é«˜æ•ˆçš„éæ¿¾ï¼‰
      const visibleMarkers = [];
      // é™åˆ¶è™•ç†æ•¸é‡ï¼Œé¿å…å¡é “
      const maxCheck = Math.min(allMarkersData.length, 10000);
      for (let i = 0; i < maxCheck; i++) {
        const markerData = allMarkersData[i];
        if (markerData.lat >= south && 
            markerData.lat <= north && 
            markerData.lng >= west && 
            markerData.lng <= east) {
          visibleMarkers.push(markerData);
        }
        // é™åˆ¶æœ€å¤šé¡¯ç¤º300å€‹ï¼Œé¿å…éå¤šæ¨™è¨˜å°è‡´å¡é “
        if (visibleMarkers.length >= 300) {
          break;
        }
      }

      // æ‰¹é‡æ·»åŠ æ¨™è¨˜ï¼ˆåˆ†æ‰¹è™•ç†ï¼Œé¿å…é˜»å¡UIï¼‰
      const batchSize = 30;
      for (let i = 0; i < visibleMarkers.length; i += batchSize) {
        const batch = visibleMarkers.slice(i, i + batchSize);
        
        batch.forEach(markerData => {
          try {
            const iconPath = getBrandIconPath(markerData.brand);
            
            const customIcon = L.icon({
              iconUrl: iconPath,
              iconSize: [40, 40],
              iconAnchor: [20, 40],
              popupAnchor: [0, -40]
            });

            const marker = L.marker([markerData.lat, markerData.lng], {
              icon: customIcon
            })
              .addTo(storeMap)
              .bindPopup(`
                <div style="min-width: 200px;">
                  <strong>${markerData.display_name}</strong><br>
                  <small>${markerData.addr || ''}</small>
                </div>
              `);

            storeMarkers.push(marker);
          } catch (e) {
            console.warn('æ·»åŠ æ¨™è¨˜å¤±æ•—:', markerData, e);
          }
        });

        // æ¯æ‰¹ä¹‹é–“æš«åœï¼Œè®“ç€è¦½å™¨æœ‰æ™‚é–“æ¸²æŸ“
        if (i + batchSize < visibleMarkers.length) {
          await new Promise(resolve => setTimeout(resolve, 20));
        }
      }

      if (statusEl) {
        const totalText = visibleMarkers.length >= 300 ? '300+' : visibleMarkers.length.toString();
        statusEl.textContent = `å·²è¼‰å…¥ ${totalText} å€‹å•†å®¶ä½ç½®ï¼ˆç¸½å…± ${allMarkersData.length} å€‹ï¼‰`;
      }

      window.isRefreshingMarkers = false;
    }

    // å…¨å±€åˆ·æ–°å‡½æ•¸ï¼ˆä¾›æŒ‰éˆ•èª¿ç”¨ï¼‰
    window.refreshMapMarkers = refreshMapMarkers;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const appStoreLink = document.getElementById('sidebar-app-store-link');
      if (appStoreLink) {
        appStoreLink.href = APP_STORE_URL;
      }
      loadCoupons();
      initTabs();
      initMobileDownloadBanner();
    });

    // æ£€æµ‹è®¾å¤‡ç±»å‹å¹¶åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¸‹è½½æ¨ªå¹…
    function detectDevice() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      
      // æ£€æµ‹ iOS
      if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return 'ios';
      }
      
      // æ£€æµ‹ Android
      if (/android/i.test(userAgent)) {
        return 'android';
      }
      
      return 'unknown';
    }

    function initMobileDownloadBanner() {
      // åªåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ˜¾ç¤º
      if (window.innerWidth > 900) {
        return;
      }

      const device = detectDevice();
      const banner = document.getElementById('mobile-download-banner');
      const downloadButton = document.getElementById('mobile-download-button');
      
      if (!banner || !downloadButton) {
        return;
      }

      // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®ä¸‹è½½é“¾æ¥
      if (device === 'ios') {
        downloadButton.href = 'https://apps.apple.com/tw/app/%E6%97%A5%E6%9C%AC%E5%84%AA%E6%83%A0%E5%88%B8-2025-%E6%97%A5%E6%9C%AC%E8%B3%BC%E7%89%A9-%E6%97%85%E9%81%8A%E5%BF%85%E5%82%99-%E6%97%A5%E5%B9%A3%E6%8F%9B%E7%AE%97/id6449156306';
      } else if (device === 'android') {
        downloadButton.href = 'https://play.google.com/store/apps/details?id=com.junlando.japancoupon';
      } else {
        // æœªçŸ¥è®¾å¤‡ï¼Œæ˜¾ç¤ºä¸¤ä¸ªé“¾æ¥éƒ½æœ‰çš„é¡µé¢æˆ–é»˜è®¤é“¾æ¥
        downloadButton.href = 'https://play.google.com/store/apps/details?id=com.junlando.japancoupon';
      }

      // æ˜¾ç¤ºæ¨ªå¹…
      banner.classList.add('show');

      // 10ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        banner.classList.add('hide');
        setTimeout(() => {
          banner.classList.remove('show', 'hide');
        }, 300); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      }, 10000);
    }
  </script>

  <!-- ç§»åŠ¨ç«¯ä¸‹è½½æ¨ªå¹… -->
  <div id="mobile-download-banner" class="mobile-download-banner">
    <div class="banner-content">
      <div class="banner-text">
        ä¸‹è¼‰æ‰‹æ©Ÿç‰ˆAPPï¼Œéš¨æ™‚éš¨åœ°ç²å–æŠ˜æ‰£ï¼
      </div>
      <a id="mobile-download-button" href="#" target="_blank" rel="noopener noreferrer" class="banner-button">
        é»æˆ‘ä¸‹è¼‰
      </a>
    </div>
  </div>
</body>
</html>
