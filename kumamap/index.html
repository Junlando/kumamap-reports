<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¯ãƒå‡ºæ²¡ãƒãƒƒãƒ—ï½œãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºæ²¡æƒ…å ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="æ—¥æœ¬å…¨å›½ã®ã‚¯ãƒå‡ºæ²¡æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã‚‹ã‚¯ãƒå‡ºæ²¡ãƒãƒƒãƒ—ã€‚æœ€æ–°ã®ç›®æ’ƒæƒ…å ±ã‚„éƒ½é“åºœçœŒåˆ¥ã®å‡ºæ²¡çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #020617;
      --card: #020617;
      --card-soft: #020617;
      --accent: #f97316;
      --accent-soft: rgba(248, 171, 96, 0.1);
      --border: #1e293b;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      max-width: 1040px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .app-tag {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-sub);
    }

    h1 {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h1 span.emoji {
      font-size: 24px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-sub);
      max-width: 640px;
      line-height: 1.5;
    }

    .headline-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.15);
      border: 1px solid rgba(45, 212, 191, 0.5);
      font-size: 11px;
      color: #a5f3fc;
      margin-top: 6px;
    }

    .headline-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 840px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(51, 65, 85, 0.8);
      box-shadow: 0 18px 55px rgba(15, 23, 42, 0.85);
      padding: 14px 14px 16px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at top right,
        rgba(248, 171, 96, 0.08),
        transparent 60%
      );
      pointer-events: none;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.8);
      color: var(--text-sub);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-sub);
    }

    .map-container {
      margin-top: 8px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    #map {
      width: 100%;
      height: 380px;
    }

    @media (max-width: 480px) {
      #map {
        height: 320px;
      }
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.9);
    }

    .side-section {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .download-card {
      background: linear-gradient(135deg, #0f172a, #020617);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 12px 12px 14px;
      position: relative;
      overflow: hidden;
    }

    .download-card::before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(
        circle at top right,
        rgba(248, 171, 96, 0.14),
        transparent 60%
      );
      opacity: 0.9;
      pointer-events: none;
    }

    .download-card-content {
      position: relative;
      z-index: 2;
    }

    .download-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .download-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .store-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .store-btn {
      flex: 1 1 46%;
      min-width: 120px;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease, background 0.12s ease;
    }

    .store-btn span.icon {
      font-size: 14px;
    }

    .store-btn:hover {
      transform: translateY(-1px);
      background: #020617;
      border-color: rgba(148, 163, 184, 0.9);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.2);
    }

    .store-btn.primary {
      background: linear-gradient(135deg, #f97316, #fb923c);
      border-color: rgba(248, 171, 96, 0.9);
      color: #111827;
      font-weight: 600;
    }

    .store-btn.primary:hover {
      box-shadow: 0 10px 25px rgba(248, 171, 96, 0.35);
    }

    .latest-card {
      background: radial-gradient(circle at top left, #020617 0, #020617 55%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 12px 12px 12px;
      position: relative;
      overflow: hidden;
    }

    .latest-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }

    .latest-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .latest-badge {
      font-size: 11px;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      color: var(--text-sub);
    }

    .latest-list {
      list-style: none;
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .latest-item {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
      font-size: 12px;
      line-height: 1.45;
    }

    .latest-item:last-child {
      border-bottom: none;
    }

    .latest-pref {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .latest-meta {
      font-size: 11px;
      color: var(--text-sub);
    }

    .latest-empty {
      font-size: 12px;
      color: var(--text-sub);
      padding: 8px 4px;
    }

    .pref-card {
      margin-top: 22px;
      background: radial-gradient(circle at top left, #020617 0, #020617 60%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 12px 12px 14px;
    }

    .pref-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .pref-title {
      font-size: 13px;
      font-weight: 600;
    }

    .pref-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .pref-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      .pref-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .pref-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .pref-link {
      font-size: 11px;
      padding: 5px 7px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-sub);
      text-align: center;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease,
        border-color 0.12s ease, transform 0.08s ease;
    }

    .pref-link:hover {
      background: rgba(15, 23, 42, 0.4);
      border-color: rgba(148, 163, 184, 0.9);
      color: var(--text-main);
      transform: translateY(-0.5px);
    }

    footer {
      margin-top: 20px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
      opacity: 0.8;
    }

    .loading {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .error {
      font-size: 11px;
      color: #fca5a5;
      margin-top: 4px;
    }

    /* Custom scrollbar (light) */
    .latest-list::-webkit-scrollbar {
      width: 6px;
    }

    .latest-list::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.7);
    }

    .latest-list::-webkit-scrollbar-thumb {
      background: rgba(75, 85, 99, 0.9);
      border-radius: 999px;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="title-row">
        <span class="app-tag">é˜²ç½ãƒ»å‡ºæ²¡æƒ…å ±</span>
      </div>
      <h1>
        <span class="emoji">ğŸ»</span>
        ã‚¯ãƒå‡ºæ²¡ãƒãƒƒãƒ—
      </h1>
      <p class="subtitle">
        æ—¥æœ¬å…¨å›½ã®ã‚¯ãƒå‡ºæ²¡æƒ…å ±ã‚’ã€åœ°å›³ã¨ãƒªã‚¹ãƒˆã§ã¾ã¨ã‚ã¦ãƒã‚§ãƒƒã‚¯ã§ãã‚‹éå…¬å¼ãƒãƒƒãƒ—ã§ã™ã€‚
        ç›´è¿‘ã®ç›®æ’ƒæƒ…å ±ã‚„éƒ½é“åºœçœŒåˆ¥ã®çŠ¶æ³ã‚’ç¢ºèªã—ã€å±±æ­©ãã‚„ãŠå‡ºã‹ã‘ã®å®‰å…¨ã«ãŠå½¹ç«‹ã¦ãã ã•ã„ã€‚
      </p>
      <div class="headline-badge">
        <span class="headline-dot"></span>
        æœ€æ–°ã®ç›®æ’ƒæƒ…å ±ã‚’é †æ¬¡åæ˜ ä¸­
      </div>
    </header>

    <main class="layout">
      <!-- Left: Map -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºæ²¡ãƒãƒƒãƒ—
              <span class="card-title-badge">ãƒ™ãƒ¼ã‚¿ç‰ˆ</span>
            </div>
            <div class="card-subtitle">
              ç›´è¿‘ã®ã‚¯ãƒå‡ºæ²¡ãƒã‚¤ãƒ³ãƒˆã‚’åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ï¼ˆéå…¬å¼ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
            </div>
          </div>
        </div>

        <div class="map-container">
          <div id="map"></div>
        </div>

        <div id="map-status" class="loading">
          åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
        </div>

        <div class="pill-row">
          <span class="pill">
            <span class="pill-dot"></span>
            ç›´è¿‘ã®ç›®æ’ƒæƒ…å ±ã®ã¿ã‚’è¡¨ç¤º
          </span>
          <span class="pill"> ã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼ˆéƒ½é“åºœçœŒãƒ»æ—¥æ™‚ï¼‰ã‚’è¡¨ç¤º </span>
        </div>
      </section>

      <!-- Right: Downloads + latest list -->
      <aside class="side-section">
        <section class="download-card">
          <div class="download-card-content">
            <div class="download-title">ã‚¯ãƒå‡ºæ²¡ãƒãƒƒãƒ— ã‚¢ãƒ—ãƒªç‰ˆ</div>
            <div class="download-subtitle">
              è¿‘ãã§ã‚¯ãƒãŒå‡ºæ²¡ã—ãŸéš›ã«é€šçŸ¥ã‚’å—ã‘å–ã‚Œã‚‹ã€é˜²ç½å‘ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒªã§ã™ã€‚
            </div>
            <div class="store-buttons">
              <!-- TODO: æ›¿æ›æˆå¯¦éš› App Store / Google Play é€£çµ -->
              <a
                class="store-btn primary"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span class="icon">ï£¿</span>
                <span>App Store ã§é–‹ã</span>
              </a>
              <a
                class="store-btn"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span class="icon">â–¶ï¸</span>
                <span>Google Playï¼ˆæº–å‚™ä¸­ï¼‰</span>
              </a>
            </div>
          </div>
        </section>

        <section class="latest-card">
          <div class="latest-title-row">
            <div class="latest-title">
              æœ€æ–°ã®å‡ºæ²¡æƒ…å ±
            </div>
            <span class="latest-badge">ç›´è¿‘ 10 ä»¶</span>
          </div>
          <ul id="latest-list" class="latest-list">
            <!-- JS æ³¨å…¥ -->
          </ul>
          <div id="latest-status" class="loading">
            å‡ºæ²¡æƒ…å ±ã‚’å–å¾—ä¸­â€¦
          </div>
        </section>
      </aside>
    </main>

    <!-- Prefecture links -->
    <section class="pref-card">
      <div class="pref-header">
        <div class="pref-title">éƒ½é“åºœçœŒåˆ¥ã®å‡ºæ²¡çŠ¶æ³ãƒšãƒ¼ã‚¸</div>
        <div class="pref-subtitle">
          å„éƒ½é“åºœçœŒã”ã¨ã®å‡ºæ²¡å±¥æ­´ãƒ»æœ€æ–°æƒ…å ±ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã§ã™ã€‚
        </div>
      </div>
      <div class="pref-grid" id="prefecture-links">
        <!-- JS ã§è‡ªå‹•ç”Ÿæˆ -->
      </div>
    </section>

    <footer>
      éå…¬å¼ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚æ­£ç¢ºãªæƒ…å ±ã¯å„è‡ªæ²»ä½“ãƒ»è­¦å¯Ÿã®å…¬å¼ç™ºè¡¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
    </footer>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ================================
    // å…¨åŸŸè®Šæ•¸
    // ================================
    let map;
    let markers = [];
    const mapStatusEl = document.getElementById("map-status");
    const latestListEl = document.getElementById("latest-list");
    const latestStatusEl = document.getElementById("latest-status");
    const prefLinksEl = document.getElementById("prefecture-links");

    // PLACES å°æ‡‰ï¼šAPI ä»£ç¢¼ â†’ é¡¯ç¤ºåç¨±
    const PREF_MAP = [
      { id: "hokkaido", name: "åŒ—æµ·é“" },
      { id: "aomori", name: "é’æ£®çœŒ" },
      { id: "miyagi", name: "å®®åŸçœŒ" },
      { id: "yamagata", name: "å±±å½¢çœŒ" },
      { id: "fukushima", name: "ç¦å³¶çœŒ" },
      { id: "tochigi", name: "æ ƒæœ¨çœŒ" },
      { id: "tokyo", name: "æ±äº¬éƒ½" },
      { id: "kanagawa", name: "ç¥å¥ˆå·çœŒ" },
      { id: "yamanashi", name: "å±±æ¢¨çœŒ" },
      { id: "shizuoka", name: "é™å²¡çœŒ" },
      { id: "nagano", name: "é•·é‡çœŒ" },
      { id: "fukui", name: "ç¦äº•çœŒ" },
      { id: "ishikawa", name: "çŸ³å·çœŒ" },
      { id: "gifu", name: "å²é˜œçœŒ" },
      { id: "aichi", name: "æ„›çŸ¥çœŒ" },
      { id: "shiga", name: "æ»‹è³€çœŒ" },
      { id: "mie", name: "ä¸‰é‡çœŒ" },
      { id: "nara", name: "å¥ˆè‰¯çœŒ" },
      { id: "wakayama", name: "å’Œæ­Œå±±çœŒ" },
      { id: "osaka", name: "å¤§é˜ªåºœ" },
      { id: "hyogo", name: "å…µåº«çœŒ" },
      { id: "tottori", name: "é³¥å–çœŒ" },
      { id: "shimane", name: "å³¶æ ¹çœŒ" },
      { id: "hiroshima", name: "åºƒå³¶çœŒ" },
      { id: "kochi", name: "é«˜çŸ¥çœŒ" },
      { id: "tokushima", name: "å¾³å³¶çœŒ" },
    ];

    function buildPrefUrl(prefId) {
      return `/kumamap/prefectures/${prefId}`;
    }

    // ================================
    // è‡ªå®šç¾© Marker åœ–æ¨™
    // ================================
    // åœ–æ¨™é…ç½®ï¼šå¯ä»¥ä¿®æ”¹é€™äº›åƒæ•¸ä¾†ä½¿ç”¨ä½ çš„è‡ªå®šç¾©åœ–ç‰‡
    const ICON_CONFIG = {
      // é¸é … 1: ä½¿ç”¨åœ–ç‰‡æ–‡ä»¶ï¼ˆæ¨è–¦ï¼‰
      // å°‡ä½ çš„åœ–æ¨™åœ–ç‰‡æ”¾åœ¨ kumamap/ ç›®éŒ„ä¸‹ï¼Œç„¶å¾Œä¿®æ”¹ä¸‹é¢çš„è·¯å¾‘
      useImageIcon: true, // ä½¿ç”¨åœ–ç‰‡åœ–æ¨™
      imageIconUrl: 'kuma_marker.png', // ä½ çš„åœ–æ¨™åœ–ç‰‡è·¯å¾‘
      imageIconSize: [32, 45], // åœ–æ¨™å¤§å° [å¯¬åº¦, é«˜åº¦]
      
      // é¸é … 2: ä½¿ç”¨ CSS/HTML è‡ªå®šç¾©åœ–æ¨™ï¼ˆå‚™ç”¨ï¼‰
      useCustomDivIcon: false, // ä¸ä½¿ç”¨ div åœ–æ¨™
    };

    // å‰µå»ºåœ–ç‰‡åœ–æ¨™ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
    let customImageIcon = null;
    if (ICON_CONFIG.useImageIcon) {
      customImageIcon = L.icon({
        iconUrl: ICON_CONFIG.imageIconUrl,
        iconSize: ICON_CONFIG.imageIconSize,
        iconAnchor: [ICON_CONFIG.imageIconSize[0] / 2, ICON_CONFIG.imageIconSize[1]], // åœ–æ¨™åº•éƒ¨ä¸­å¿ƒé»
        popupAnchor: [0, -ICON_CONFIG.imageIconSize[1]], // Popup ä½ç½®
      });
    }

    // å‰µå»ºè‡ªå®šç¾© div åœ–æ¨™ï¼ˆç†Šåœ–æ¨™æ¨£å¼ï¼‰
    const customDivIcon = L.divIcon({
      className: 'custom-marker-icon',
      html: '<div style="background-color: #f97316; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><span style="color: white; font-size: 20px; transform: rotate(45deg); display: block; text-align: center; line-height: 24px;">ğŸ»</span></div>',
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -30]
    });

    // æ±ºå®šä½¿ç”¨å“ªå€‹åœ–æ¨™
    const markerIcon = ICON_CONFIG.useImageIcon && customImageIcon 
      ? customImageIcon 
      : customDivIcon;

    // ================================
    // åœ°åœ–åˆå§‹åŒ–
    // ================================
    function initMap() {
      // åˆå§‹åŒ–åœ°åœ–ï¼ˆä¸­å¿ƒæ”¾åœ¨æ—¥æœ¬ï¼‰
      map = L.map("map").setView([37.5, 138], 5.3);

      // åŠ å…¥ OpenStreetMap åœ–ç£š
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
        maxZoom: 18,
      }).addTo(map);

      // è¼‰å…¥ incidents
      loadIncidents();
    }

    // ================================
    // å¾æœ¬åœ° data.json å–å¾—è³‡æ–™ä¸¦é¡¯ç¤º markers
    // ================================
    async function loadIncidents() {
      try {
        mapStatusEl.textContent = "åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";
        
        // å¾æœ¬åœ° data.json è®€å–è³‡æ–™
        const res = await fetch("data.json");
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ç„¡æ³•è®€å– data.json`);
        }
        
        const incidents = await res.json();
        console.log("loaded incidents:", incidents);

        // æ¸…é™¤ç¾æœ‰çš„ markers
        markers.forEach((marker) => {
          map.removeLayer(marker);
        });
        markers = [];

        if (!incidents || incidents.length === 0) {
          mapStatusEl.textContent = "è¡¨ç¤ºã§ãã‚‹å‡ºæ²¡æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }

        const bounds = [];
        incidents.forEach((item) => {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);

          if (isNaN(lat) || isNaN(lng) || !lat || !lng) {
            console.warn("Invalid coordinates:", item);
            return;
          }

          // å°æ•¸é»4ä½
          const latStr = lat.toFixed(4);
          const lngStr = lng.toFixed(4);

          // å–å¾—éƒ½é“åºœçœŒåç¨±
          const prefName = PREF_MAP.find((p) => p.id === item.prefecture)?.name || item.prefecture || "ä¸æ˜";
          
          // æ ¼å¼åŒ–æ™‚é–“
          let timeStr = item.timestamp || "ä¸æ˜";
          if (timeStr !== "ä¸æ˜" && timeStr.includes("T")) {
            timeStr = timeStr.replace("T", " ").substring(0, 16);
          }
          
          // å»ºç«‹ popup å…§å®¹
          let desc = `<strong>${prefName}</strong><br>`;
          desc += `ç·¯åº¦: ${latStr}<br>çµŒåº¦: ${lngStr}<br>æ™‚é–“: ${timeStr}`;
          if (item.description) {
            const shortDesc = item.description.length > 100 
              ? item.description.substring(0, 100) + "..." 
              : item.description;
            desc += `<br><br>${shortDesc}`;
          }

          // ä½¿ç”¨è‡ªå®šç¾©åœ–æ¨™å‰µå»º marker
          const marker = L.marker([lat, lng], {
            icon: markerIcon // ä½¿ç”¨é…ç½®çš„åœ–æ¨™ï¼ˆkuma_marker.pngï¼‰
          })
            .addTo(map)
            .bindPopup(desc);

          markers.push(marker);
          bounds.push([lat, lng]);
        });

        // å¦‚æœæœ‰ markersï¼Œèª¿æ•´åœ°åœ–è¦–è§’
        if (bounds.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds(), { padding: [30, 30] });
          mapStatusEl.textContent = `${bounds.length}ä»¶ã®å‡ºæ²¡æƒ…å ±ã‚’è¡¨ç¤ºä¸­`;
        } else {
          mapStatusEl.textContent = "è¡¨ç¤ºã§ãã‚‹å‡ºæ²¡æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        }
      } catch (e) {
        console.error("failed to load incidents", e);
        mapStatusEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        mapStatusEl.className = "error";
      }
    }

    // ================================
    // Prefecture é€£çµç”Ÿæˆ
    // ================================
    function renderPrefLinks() {
      PREF_MAP.forEach((pref) => {
        const a = document.createElement("a");
        a.className = "pref-link";
        a.href = buildPrefUrl(pref.id);
        a.textContent = pref.name;
        prefLinksEl.appendChild(a);
      });
    }

    // ================================
    // åˆå§‹åŒ–
    // ================================
    // ç­‰å¾… DOM å’Œ Leaflet è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–åœ°åœ–
    function waitForLeaflet() {
      if (typeof L !== "undefined") {
        initMap();
        renderPrefLinks();
      } else {
        setTimeout(waitForLeaflet, 100);
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", waitForLeaflet);
    } else {
      waitForLeaflet();
    }
  </script>
</body>
</html>