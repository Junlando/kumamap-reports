<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/kumamap/app_icon.png">
  <title>最新動態｜クマ出没マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="日本全国のクマ出没情報の最新動態。過去30日間の出没情報を地図で確認できます。"
  />
  <link rel="canonical" href="https://junlando.com/kumamap/latest/" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --ink: #111827;
      --ink-soft: #4b5563;
      --accent: #b91c1c;
      --border: #e5e7eb;
      --bg: #fff;
      --bg-muted: #f9fafb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 16px 0;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: var(--ink);
    }

    .logo img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
    }

    .header-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-tab {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      color: var(--ink-soft);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .nav-tab:hover {
      background: var(--bg-muted);
      color: var(--ink);
    }

    .nav-tab.active {
      background: var(--accent);
      color: #fff;
    }

    .nav-tab.active:hover {
      background: #a01717;
    }

    /* Latest Activity Page */
    .latest-activity-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .latest-activity-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 32px;
      align-items: start;
    }

    .latest-activity-map {
      background: var(--bg-muted);
      padding: 32px;
      border-radius: 8px;
    }

    .latest-activity-map h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .latest-activity-map .subtitle {
      font-size: 14px;
      color: var(--ink-soft);
      margin-bottom: 24px;
    }

    .map-container {
      border: 1px solid var(--border);
      background: #fff;
      padding: 18px;
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .map-wrapper {
      width: 100%;
      height: 500px;
      border-radius: 4px;
      overflow: hidden;
    }

    #map-30days-latest {
      width: 100%;
      height: 100%;
    }

    .map-status {
      margin-top: 12px;
      font-size: 14px;
      color: var(--ink-soft);
    }

    .latest-incidents-list {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      max-height: 800px;
      overflow-y: auto;
    }

    .latest-incidents-list h2 {
      font-size: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent);
      padding-left: 12px;
    }

    .incident-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
      border-radius: 4px;
    }

    .incident-item:last-child {
      border-bottom: none;
    }

    .incident-item:hover {
      background: var(--bg-muted);
    }

    .incident-item-group {
      margin-bottom: 20px;
    }

    .incident-pref {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 8px;
    }

    .incident-coords {
      font-size: 13px;
      color: var(--ink-soft);
      margin-bottom: 4px;
      font-family: monospace;
    }

    .incident-time {
      font-size: 12px;
      color: var(--ink-soft);
    }

    /* Footer */
    footer {
      border-top: 1px solid var(--border);
      padding: 32px 24px;
      text-align: center;
      color: var(--ink-soft);
      font-size: 14px;
      background: var(--bg-muted);
    }

    /* Responsive */
    @media (max-width: 968px) {
      .latest-activity-grid {
        grid-template-columns: 1fr;
      }

      .latest-incidents-list {
        max-height: 500px;
      }

      .header-nav {
        flex-wrap: wrap;
        gap: 4px;
      }

      .nav-tab {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDonsfxblXXS-AFv7sZDTSpX5dr7Z3GuFc",
      authDomain: "kumamapweb.firebaseapp.com",
      projectId: "kumamapweb",
      storageBucket: "kumamapweb.firebasestorage.app",
      messagingSenderId: "322213314578",
      appId: "1:322213314578:web:c859638e33cbb7313a18cb",
      measurementId: "G-4QPCVSXMQ7"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
  </script>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <a href="/kumamap/" class="logo">
        <img src="/kumamap/app_icon.png" alt="クマ出没マップ" />
        <span>クマ出没マップ</span>
      </a>
      <nav class="header-nav">
        <a href="/kumamap/" class="nav-tab">首頁</a>
        <a href="/kumamap/latest/" class="nav-tab active">最新動態</a>
        <a href="/kumamap/history/" class="nav-tab">歷史紀錄</a>
        <a href="/kumamap/about/" class="nav-tab">關於我們</a>
      </nav>
    </div>
  </header>

  <div class="latest-activity-page">
    <div class="latest-activity-grid">
      <div class="latest-activity-map">
        <h2>最近30日間の日本クマ出没情報</h2>
        <p class="subtitle">過去30日間の都道府県別出没件数を色の濃淡で表示しています</p>
        
        <div class="map-container">
          <div class="map-wrapper">
            <div id="map-30days-latest"></div>
          </div>
          <div id="map-30days-latest-status" class="map-status">地図データを読み込み中…</div>
        </div>
      </div>

      <div class="latest-incidents-list">
        <h2>最新出没位置</h2>
        <div id="latest-incidents-list-content">
          <div>データ読み込み中…</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>© 2025 クマ出没マップ. 非公式ツールです。正確な情報は各自治体・警察の公式発表をご確認ください。</p>
  </footer>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ================================
    // 全域變數
    // ================================
    let map30DaysLatest;
    let markers30DaysLatest = [];
    
    const map30DaysLatestStatusEl = document.getElementById("map-30days-latest-status");
    const latestIncidentsListEl = document.getElementById("latest-incidents-list-content");

    // 都道府県對應：API 代碼 → 顯示名稱
    const PREF_MAP = [
      { id: "hokkaido", name: "北海道", lat: 43.0642, lng: 141.3469 },
      { id: "aomori", name: "青森県", lat: 40.8244, lng: 140.7406 },
      { id: "iwate", name: "岩手県", lat: 39.7036, lng: 141.1527 },
      { id: "miyagi", name: "宮城県", lat: 38.2688, lng: 140.8721 },
      { id: "akita", name: "秋田県", lat: 39.7186, lng: 140.1024 },
      { id: "yamagata", name: "山形県", lat: 38.2404, lng: 140.3633 },
      { id: "fukushima", name: "福島県", lat: 37.7503, lng: 140.4676 },
      { id: "ibaraki", name: "茨城県", lat: 36.3414, lng: 140.4467 },
      { id: "tochigi", name: "栃木県", lat: 36.5658, lng: 139.8836 },
      { id: "gunma", name: "群馬県", lat: 36.3911, lng: 139.0608 },
      { id: "saitama", name: "埼玉県", lat: 35.8617, lng: 139.6455 },
      { id: "chiba", name: "千葉県", lat: 35.6074, lng: 140.1065 },
      { id: "tokyo", name: "東京都", lat: 35.6762, lng: 139.6503 },
      { id: "kanagawa", name: "神奈川県", lat: 35.4475, lng: 139.6425 },
      { id: "niigata", name: "新潟県", lat: 37.9022, lng: 139.0236 },
      { id: "toyama", name: "富山県", lat: 36.6953, lng: 137.2113 },
      { id: "ishikawa", name: "石川県", lat: 36.5947, lng: 136.6256 },
      { id: "fukui", name: "福井県", lat: 36.0652, lng: 136.2216 },
      { id: "yamanashi", name: "山梨県", lat: 35.6642, lng: 138.5684 },
      { id: "nagano", name: "長野県", lat: 36.6513, lng: 138.1810 },
      { id: "gifu", name: "岐阜県", lat: 35.3912, lng: 136.7223 },
      { id: "shizuoka", name: "静岡県", lat: 34.9769, lng: 138.3830 },
      { id: "aichi", name: "愛知県", lat: 35.1803, lng: 136.9066 },
      { id: "mie", name: "三重県", lat: 34.7303, lng: 136.5086 },
      { id: "shiga", name: "滋賀県", lat: 35.0045, lng: 135.8686 },
      { id: "kyoto", name: "京都府", lat: 35.0212, lng: 135.7556 },
      { id: "osaka", name: "大阪府", lat: 34.6863, lng: 135.5197 },
      { id: "hyogo", name: "兵庫県", lat: 34.6913, lng: 135.1830 },
      { id: "nara", name: "奈良県", lat: 34.6853, lng: 135.8327 },
      { id: "wakayama", name: "和歌山県", lat: 34.2261, lng: 135.1675 },
      { id: "tottori", name: "鳥取県", lat: 35.5039, lng: 134.2377 },
      { id: "shimane", name: "島根県", lat: 35.4723, lng: 133.0505 },
      { id: "okayama", name: "岡山県", lat: 34.6617, lng: 133.9350 },
      { id: "hiroshima", name: "広島県", lat: 34.3960, lng: 132.4596 },
      { id: "yamaguchi", name: "山口県", lat: 34.1858, lng: 131.4706 },
      { id: "tokushima", name: "徳島県", lat: 34.0658, lng: 134.5594 },
      { id: "kagawa", name: "香川県", lat: 34.3401, lng: 134.0433 },
      { id: "ehime", name: "愛媛県", lat: 33.8416, lng: 132.7657 },
      { id: "kochi", name: "高知県", lat: 33.5597, lng: 133.5311 },
      { id: "fukuoka", name: "福岡県", lat: 33.6064, lng: 130.4181 },
      { id: "saga", name: "佐賀県", lat: 33.2494, lng: 130.2988 },
      { id: "nagasaki", name: "長崎県", lat: 32.7448, lng: 129.8737 },
      { id: "kumamoto", name: "熊本県", lat: 32.7898, lng: 130.7417 },
      { id: "oita", name: "大分県", lat: 33.2382, lng: 131.6126 },
      { id: "miyazaki", name: "宮崎県", lat: 31.9077, lng: 131.4202 },
      { id: "kagoshima", name: "鹿児島県", lat: 31.5602, lng: 130.5581 },
      { id: "okinawa", name: "沖縄県", lat: 26.2124, lng: 127.6809 },
    ];

    const PREF_ALIASES = {
      shimanetottori: "島根県",
      narakizugawa: "京都府",
    };

    const PREF_REMAP = {
      shimanetottori: "shimane",
      narakizugawa: "kyoto",
    };
    const BLOCKED_PREFS = new Set(["yamanashi"]);

    const JST_OFFSET_MS = 9 * 60 * 60 * 1000;
    const API_BASE = "https://kumamap.junlando.com/incidents/";

    // ================================
    // Helper Functions
    // ================================
    function getPrefName(prefId) {
      const normalized = (prefId || "").toLowerCase();
      if (PREF_ALIASES[normalized]) {
        return PREF_ALIASES[normalized];
      }
      return (
        PREF_MAP.find((p) => p.id === normalized)?.name ||
        prefId ||
        "不明"
      );
    }

    function getPrefCoords(prefId) {
      const normalized = (prefId || "").toLowerCase();
      const pref = PREF_MAP.find((p) => p.id === normalized);
      return pref ? [pref.lat, pref.lng] : null;
    }

    function buildPrefSummary(items) {
      const counts = new Map();
      items.forEach((item) => {
        const id = (item.prefecture || "").toLowerCase();
        const name = getPrefName(id);
        counts.set(id, { id, name, count: (counts.get(id)?.count || 0) + 1 });
      });
      return Array.from(counts.values()).sort(
        (a, b) => b.count - a.count || a.name.localeCompare(b.name)
      );
    }

    function getColorByCount(count, maxCount) {
      if (count === 0) return '#f0f0f0';
      if (maxCount === 0) return '#f0f0f0';
      const ratio = count / maxCount;
      // 从浅红到深红：白色 -> 浅红 -> 深红
      if (ratio < 0.1) {
        return '#ffcccc';
      } else if (ratio < 0.3) {
        return '#ff9999';
      } else if (ratio < 0.5) {
        return '#ff6666';
      } else if (ratio < 0.7) {
        return '#ff3333';
      } else {
        return '#cc0000';
      }
    }

    // ================================
    // 最新动态页面 - 30天热力图
    // ================================
    function initMap30DaysLatest() {
      map30DaysLatest = L.map("map-30days-latest").setView([36.5, 138.0], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        maxZoom: 18,
      }).addTo(map30DaysLatest);
    }

    async function load30DaysDataLatest() {
      try {
        if (map30DaysLatestStatusEl) {
          map30DaysLatestStatusEl.textContent = "データを読み込み中…";
        }
        
        // 获取今天日本时间 0:00 的 UTC 时间戳
        const now = new Date();
        const todayJst = new Date(now.getTime() + JST_OFFSET_MS);
        const todayStartUtc = Date.UTC(todayJst.getUTCFullYear(), todayJst.getUTCMonth(), todayJst.getUTCDate()) - JST_OFFSET_MS;
        const thirtyDaysAgoUtc = todayStartUtc - (30 * 24 * 60 * 60 * 1000);
        
        const afterSeconds = Math.floor(thirtyDaysAgoUtc / 1000);
        const beforeSeconds = Math.floor(todayStartUtc / 1000);

        const query = new URLSearchParams();
        query.set("created_after", afterSeconds);
        query.set("created_before", beforeSeconds);
        const apiUrl = `${API_BASE}?${query.toString()}`;
        
        const res = await fetch(apiUrl);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: API の取得に失敗しました`);
        }

        const incidents = (await res.json())
          .map((item) => ({
            ...item,
            prefecture: PREF_REMAP[item.prefecture?.toLowerCase()] ?? item.prefecture,
          }))
          .filter((item) => {
            const pref = (item.prefecture || "").toLowerCase();
            return !BLOCKED_PREFS.has(pref);
          });

        // 清除現有的 markers
        if (markers30DaysLatest) {
          markers30DaysLatest.forEach((marker) => {
            if (map30DaysLatest) map30DaysLatest.removeLayer(marker);
          });
        }
        markers30DaysLatest = [];

        // 构建都道府县统计
        const summary = buildPrefSummary(incidents);
        
        // 找到最大数量
        const maxCount = Math.max(...summary.map((s) => s.count), 1);

        // 为每个都道府县创建圆形标记
        summary.forEach((item) => {
          const coords = getPrefCoords(item.id);
          if (!coords || !map30DaysLatest) return;

          const color = getColorByCount(item.count, maxCount);
          const radius = Math.max(8, Math.min(30, 8 + (item.count / maxCount) * 22));

          const circle = L.circleMarker(coords, {
            radius: radius,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.7,
          })
            .addTo(map30DaysLatest)
            .bindPopup(`<strong>${item.name}</strong><br>過去30日間: ${item.count}件`);

          markers30DaysLatest.push(circle);
        });

        // 显示最新出没位置列表（按时间倒序）
        const sortedIncidents = incidents
          .filter(item => {
            const lat = parseFloat(item.latitude);
            const lng = parseFloat(item.longitude);
            return !isNaN(lat) && !isNaN(lng) && lat && lng;
          })
          .sort((a, b) => {
            const tsA = a.timestamp_second || 0;
            const tsB = b.timestamp_second || 0;
            return tsB - tsA; // 最新的在上面
          })
          .slice(0, 50); // 只显示最新的50条

        renderLatestIncidentsList(sortedIncidents);

        if (map30DaysLatestStatusEl) {
          map30DaysLatestStatusEl.textContent = `過去30日間の出没情報を表示中（合計 ${incidents.length} 件）`;
        }
      } catch (e) {
        console.error("failed to load 30 days data latest", e);
        if (map30DaysLatestStatusEl) {
          map30DaysLatestStatusEl.textContent = "データの取得に失敗しました。";
        }
      }
    }

    function renderLatestIncidentsList(incidents) {
      if (!latestIncidentsListEl) return;

      if (!incidents || incidents.length === 0) {
        latestIncidentsListEl.innerHTML = "<div style='padding: 20px; text-align: center; color: var(--ink-soft);'>現在表示できる出没情報はありません。</div>";
        return;
      }

      // 按都道府县分组
      const groupedByPref = {};
      incidents.forEach(item => {
        const prefId = (item.prefecture || "").toLowerCase();
        const prefName = getPrefName(prefId);
        if (!groupedByPref[prefName]) {
          groupedByPref[prefName] = [];
        }
        groupedByPref[prefName].push(item);
      });

      let html = '';
      Object.keys(groupedByPref).sort().forEach(prefName => {
        const prefIncidents = groupedByPref[prefName];
        html += `<div class="incident-item-group" style="margin-bottom: 24px;">`;
        html += `<div class="incident-pref">${prefName}</div>`;
        
        prefIncidents.forEach(item => {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          const latStr = lat.toFixed(4);
          const lngStr = lng.toFixed(4);
          
          const timeStr = item.timestamp_second 
            ? new Date(item.timestamp_second * 1000).toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              })
            : '時間不明';
          
          html += `
            <div class="incident-item" style="margin-left: 16px; margin-top: 8px;">
              <div class="incident-coords">緯度: ${latStr}, 経度: ${lngStr}</div>
              <div class="incident-time">${timeStr}</div>
            </div>
          `;
        });
        
        html += `</div>`;
      });

      latestIncidentsListEl.innerHTML = html;
    }

    // ================================
    // 初始化
    // ================================
    function waitForLeaflet() {
      if (typeof L !== "undefined") {
        initMap30DaysLatest();
        load30DaysDataLatest();
      } else {
        setTimeout(waitForLeaflet, 100);
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", waitForLeaflet);
    } else {
      waitForLeaflet();
    }
  </script>
</body>
</html>
